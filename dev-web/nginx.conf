# nginx.conf
http {
    # Allow dynamic resolution of Cloud Run domains
    resolver 8.8.8.8 valid=300s ipv6=off;

    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  www.databookman.com databookman.com dev.databookman.com;

        root /usr/share/nginx/html;

        # Portal SPA entrypoint
        location / {
            try_files $uri /index.html;
        }

        # Proxy /diplomacy to the Diplomacy Cloud Run service
        location ~ ^/diplomacy(/.*|$) {
            proxy_pass https://diplomacy.databookman.com$1;
            proxy_set_header Host              diplomacy.databookman.com;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_ssl_server_name on;           # SNI for HTTPS upstream
            proxy_ssl_verify       off;         # skip CA verification (optional)
            proxy_connect_timeout  300s;        # allow for cold starts
            proxy_read_timeout     300s;
            proxy_send_timeout     300s;
        }

        # Proxy /dailyprophet to the Daily Prophet Cloud Run service
        location ~ ^/dailyprophet(/.*|$) {
            proxy_pass https://dailyprophet.databookman.com$1;
            proxy_set_header Host              dailyprophet.databookman.com;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_ssl_server_name on;
            proxy_ssl_verify       off;
            proxy_connect_timeout  300s;
            proxy_read_timeout     300s;
            proxy_send_timeout     300s;
        }
    }
}
